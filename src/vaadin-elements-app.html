<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/icons.html">
<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="shared-styles.html">

<link rel="lazy-import" href="employee-list.html">
<link rel="lazy-import" href="employee-sales.html">
<link rel="lazy-import" href="employee-new.html">
<link rel="lazy-import" href="404.html">

<dom-module id="vaadin-elements-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }
      app-header {
        color: var(--lumo-base-color);
        background-color: var(--lumo-primary-color);
      }
      app-header vaadin-button {
        color: var(--lumo-base-color);
      }
      .drawer-list {
        margin: var(--lumo-space-tall-m);
      }
      .drawer-list stencil-route-link > a {
        display: block;
        padding: 0 var(--lumo-space-m);
        color: var(--lumo-secondary-text-color);
        line-height: var(--lumo-size-m);
        text-decoration: none;
      }
      .drawer-list stencil-route-link > a.link-active {
        color: var(--lumo-body-text-color);
        font-weight: bold;
      }
    </style>

    <app-drawer-layout fullbleed narrow="{{narrow}}">
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
        <app-toolbar>Menu</app-toolbar>
        <nav class="drawer-list" role="navigation">
          <stencil-route-link url="[[rootPath]]employee-list" url-match="[[_startPageUrlMatch()]]" exact>Employee list</stencil-route-link>
          <stencil-route-link url="[[rootPath]]employee-sales">Employee sales</stencil-route-link>
          <stencil-route-link url="[[rootPath]]employee-new">New employee</stencil-route-link>
        </nav>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header slot="header" condenses reveals effects="waterfall">
          <app-toolbar>
            <vaadin-button theme="icon" aria-label="Toggle menu" drawer-toggle>
              <iron-icon icon="lumo:menu"></iron-icon>
            </vaadin-button>
            <div main-title>vaadin-elements-app</div>
          </app-toolbar>
        </app-header>

        <stencil-router>
          <stencil-route group="main" url="[[_startPageUrlMatch()]]" exact component="employee-list" route-render="[[render]]"></stencil-route>
          <stencil-route group="main" url="[[rootPath]]employee-sales" component="employee-sales" route-render="[[render]]"></stencil-route>
          <stencil-route group="main" url="[[rootPath]]employee-new" component="employee-new" route-render="[[render]]"></stencil-route>

          <!-- @stencil/router 0.0.25 has a bug: the search order in a group varies randomly between app reloads
               sometimes the 404 route would be matched first and sometimes the correct route would be matched before.
               To avoid random 404 screens, remove the 404 route altogether. -->
          <!-- <stencil-route group="main" component="app-404" route-render=[[render]]></stencil-route> -->
        </stencil-router>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    // Gesture events like tap and track generated from touch will not be
    // preventable, allowing for better scrolling performance.
    Polymer.setPassiveTouchGestures(true);

    class VaadinElementsApp extends Polymer.Element {
      static get is() {
        return 'vaadin-elements-app';
      }

      static get properties() {
        return {
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,
        };
      }

      constructor() {
        super();
        this.render = this._render.bind(this);
      }

      ready() {
        super.ready();

        const activeRouter = window.stencilrouter.Context.activeRouter;
        activeRouter.subscribe(this._routeChanged.bind(this));
      }

      _routeChanged() {
        // Close a non-persistent drawer when the page & route are changed.
        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      }

      _startPageUrlMatch() {
        return [this.rootPath, `${this.rootPath}employee-list`];
      }
      
      _render(props) {
        const page = props.component === 'app-404' ? '404' : props.component;
        const resolvedPageUrl = this.resolveUrl(page + '.html');
        Polymer.importHref(resolvedPageUrl, null, null, true);
        return window.stencilrouter.h(props.component, props);
      }
    }
    window.customElements.define(VaadinElementsApp.is, VaadinElementsApp);
  </script>
</dom-module>
